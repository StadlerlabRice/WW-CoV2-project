---
title: "Allfigs"
author: "Prashant Kalvapalle"
date: '`r format(Sys.time(), "%d %B, %Y; %H:%M")`'
output: 
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
---


```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.width = 8, fig.height = 4)

```

## Individual plots by method 

### Copies/L WW 

#### Copies ww/N1 by method
```{r indn1}
plt_N1 <- {individual_plots(target_string = 'N1', plt.save = 'no') + 
    # ylim(N_ww) +
    scale_y_log10(labels = fancy_scientific, limits = N_ww)} %>% 
  print()
```

#### Copies ww/N2 by method
```{r indn2}
plt_N2 <- individual_plots(target_string = 'N2', plt.save = 'no') + 
    # ylim(N_ww) +
    scale_y_log10(labels = fancy_scientific, limits = N_ww)

# patch1 <- plt_N1 + plt_N2
# patch1
```

#### Copies ww/pMMoV by method
```{r indpMMoV}
plt_pMMoV <- {individual_plots(target_string = 'pMMoV') + 
    scale_y_log10(labels = fancy_scientific, limits = bcov_ww)} %>% 
  print()
```

#### Copies ww/BCoV by method
```{r indBCoV}
plt_BCoV <- {individual_plots(target_string = 'BCoV') +
    scale_y_log10(labels = fancy_scientific, limits = bcov_ww)} %>% 
  print()
```

--------------------------------------------------------------------------------------

### Copies/uL RNA

#### Copies RNA/N1 by method
```{r indN1_rna}
plt_N1_RNA <- individual_plots(target_string = 'N1', y_var = `Copies/uL RNA`, plt.save = 'yes', plt.format = 'png') +
  scale_y_log10(labels = fancy_scientific, limits = N_RNA)
```

#### Copies RNA/N2 by method
```{r indN2_rna}
plt_N2_RNA <- individual_plots(target_string = 'N2', y_var = `Copies/uL RNA`, plt.save = 'no') +
  scale_y_log10(labels = fancy_scientific, limits = N_RNA)

```

#### Copies RNA/pMMoV by method
```{r indpmmov_rna}
plt_pMMoV_RNA <- {individual_plots(target_string = 'pMMoV', y_var = `Copies/uL RNA`) +
    scale_y_log10(labels = fancy_scientific, limits = bcov_RNA)} %>% 
  print()

```


#### Copies RNA/BCoV by method
```{r indBCoV_rna}
plt_BCoV_RNA <- {individual_plots(.data_to_plot = all_data_input, target_string = 'BCoV', y_var = `Copies/uL RNA`) +
    scale_y_log10(labels = fancy_scientific, limits = bcov_RNA)} %>% 
  print()


plt_BCoV + plt_pMMoV + plt_BCoV_RNA + plt_pMMoV_RNA + 
  plot_layout(guides = 'collect') + 
  plot_annotation(tag_levels = 'A')

save_plot('BCoV_pMMoV_4 panel', sv.category = 'patched', plt.width = 14, plt.height = 7)
```

### Patched 4 panel plot 
````{r patchedn12}
plt_N1 + plt_N2 + plt_N1_RNA + plt_N2_RNA + 
  plot_layout(guides = 'collect') + 
  plot_annotation(tag_levels = 'A') #& 
  # theme(legend.position = 'bottom')

save_plot('N12_4 panel', sv.category = 'patched', plt.width = 14, plt.height = 7)
```

--------------------------------------------------------------------------------------
### Recovery fraction
```{r reco}
plt_BCoV_recovery <- individual_plots(.data_to_plot = all_data_input, target_string = 'BCoV', y_var = Fraction.recovered)
```

## Normalized to Recovery fraction

### N1 by recovery fraction
```{r n1byreco}

longer_for_reco_fraction <- scatter_data_N_reco %>% 
  pivot_longer(cols = starts_with('Copies/L WW'), names_to = c(NA, 'Target'), names_sep = '_', values_to = 'Copies/L WW')


plt_N1byreco <- {individual_plots(.data_to_plot = longer_for_reco_fraction, 
                                  y_var = `Copies/L WW` / `Fraction.recovered_BCoV2`,
                                  target_string = 'N1', plt.save = 'no', plt.LOQ = 'no',
                                  plt.log = 'no') #+ 
    # ylim(N_ww) +
    } %>% 
  print()

plt_N1byreco %>% format_logscale_y() %>% print()
```

### pMMoV by recovery fraction

```{r pmmovbyreco}

plt_pmmovbyreco <- {individual_plots(.data_to_plot = longer_for_reco_fraction, 
                                  y_var = `Copies/L WW` / `Fraction.recovered_BCoV2`,
                                  target_string = 'pMMoV', plt.save = 'no', plt.LOQ = 'no',
                                  plt.log = 'no') #+ 
    # ylim(N_ww) +
    } %>% 
  print()

plt_pmmovbyreco %>% format_logscale_y() %>% print()

```



## Correlation plots

```{r scatter1, echo=FALSE}

# plot N1 vs recovery
plt.scatter_N1_recovery <- {scatter_data_N_reco %>% 

    ggplot(aes(`Copies/L WW_SARS CoV-2 N1`, Fraction.recovered_BCoV2, colour = `Concentration method`,  shape = WWTP)) + 
    geom_point() +
    ggtitle('SARS-CoV2 N1 vs surrogate recovery fraction across methods') + 
    scale_shape_manual(values = c(15,16,17,7,8,10,3))} %>% 
  # format_logscale_y() %>%
  format_classic() %>% 
  print()

```

### Correlation across all data
```{r corall}

# correlation plot single

# plt.correlation_scatter_N1_recovery <-{ plt.scatter_N1_recovery + geom_smooth(method = 'lm', mapping = aes(group = NA))} %>% 
#   print()

  # with R2 and equation
plt.correlation_scatter_N1_recovery <-  {plot_scatter(.data = scatter_data_N_reco,
             x_var = `Copies/L WW_SARS CoV-2 N1`, y_var = Fraction.recovered_BCoV2,
             colour_var = `Concentration method`,  shape_var = WWTP,
             already_pivoted_data = 'yes',
             title_text = 'SARS-CoV2 N1 vs surrogate recovery fraction across methods') + 
    scale_shape_manual(values = c(15,16,17,7,8,10,3)) } %>% 
  format_classic() %>% 
  print()

# save_plot('cor_all', sv.category = 'Correlation')

```

### Correlation across methods
```{r corrmeth}

# correlation plot by method
plt.method.correlation_scatter_N1_recovery <- {plt.scatter_N1_recovery + geom_smooth(method = 'lm', mapping = aes(group = `Concentration method`))} %>% 
  print()

# save_plot('cor_method', sv.category = 'Correlation')

```

### Correlation across WWTP
```{r corrWWTP}

# correlation plot by WWTP
plt.bywwtp_N1_recovery <- {scatter_data_N_reco %>% 
    # filter(str_detect(Target, 'N2')) %>% 
    ggplot(aes(`Copies/L WW_SARS CoV-2 N1`, Fraction.recovered_BCoV2, shape = `Concentration method`,  colour = WWTP)) + 
    geom_point() +
    geom_smooth(method = 'lm', mapping = aes(group = WWTP)) +
    ggtitle('SARS-CoV2 N1 vs surrogate recovery fraction across methods') #+ 
    # scale_shape_manual(values = c(15,16,17,7,8,10,3))
  } %>%
  # format_logscale_y() %>%
  format_classic() %>% 
  print()

# save_plot('cor_wwtp', sv.category = 'Correlation')

```

### Correlation across all categories (removing direct extraction)
```{r corallminusdirect}

# (without direct extraction) correlation plot by WWTP

# plt.nodirect_corr_all <- {scatter_data_N_reco %>% 
#     filter(!str_detect(`Concentration method`, 'Direct')) %>% 
#     
#     ggplot(aes(`Copies/L WW_SARS CoV-2 N1`, Fraction.recovered_BCoV2, colour = `Concentration method`,  shape = WWTP)) + 
#     geom_point() +
#     ggtitle('SARS-CoV2 N1 vs surrogate recovery fraction across methods') + 
#     scale_shape_manual(values = c(15,16,17,7,8,10,3))  +
#     geom_smooth(method = 'lm', mapping = aes(group = NA))} %>% 
#   # format_logscale_y() %>%
#   format_classic() %>% 
#   print()

  # with R2 and equation
plt.nodirect_corr_all <-  {plot_scatter(.data = scatter_data_N_reco %>% 
                                         filter(!str_detect(`Concentration method`, 'Direct')),
             x_var = `Copies/L WW_SARS CoV-2 N1`, y_var = Fraction.recovered_BCoV2,
             colour_var = `Concentration method`,  shape_var = WWTP,
             already_pivoted_data = 'yes',
             title_text = 'SARS-CoV2 N1 vs surrogate recovery fraction across methods') + 
    scale_shape_manual(values = c(15,16,17,7,8,10,3)) }  %>% 
  format_classic() %>% 
  print()

# save_plot('nodirect_cor_all', sv.category = 'Correlation')

```


### Correlation across all categories (removing direct extraction and elution)
```{r corallminusdirectandel}

# (without direct extraction and elution methods)   # with R2 and equation
plt.nodirectelution_corr_all <-  {plot_scatter(.data = scatter_data_N_reco %>% 
                                         filter(!str_detect(`Concentration method`, 'Direct|Elution')),
             x_var = `Copies/L WW_SARS CoV-2 N1`, y_var = Fraction.recovered_BCoV2,
             colour_var = `Concentration method`,  shape_var = WWTP,
             already_pivoted_data = 'yes',
             title_text = 'SARS-CoV2 N1 vs surrogate recovery fraction across methods') + 
    scale_shape_manual(values = c(15,16,17,7,8,10,3)) }  %>% 
  format_classic() %>% 
  print()

# save_plot('nodirect-noelution_cor_all', sv.category = 'Correlation')

```

### Correlation BCoV vs pMMoV
```{r corallbcovpmmov}

# with R2 and equation
plt.correlation_scatter_bcov_pmmov <-  {plot_scatter(.data = scatter_data_N_reco,
             x_var = `Copies/L WW_BCoV2`, y_var = `Copies/L WW_pMMoV_Vgp1`,
             colour_var = `Concentration method`,  shape_var = WWTP,
             already_pivoted_data = 'yes',
             title_text = 'SARS-CoV2 N1 vs surrogate recovery fraction across methods') + 
    scale_shape_manual(values = c(15,16,17,7,8,10,3)) } %>% 
  format_classic() %>% 
  print()

# save_plot('BCoV vs pMMoV cor_all', sv.category = 'Correlation')

```

### Correlation N1 vs pMMoV
```{r coralln1pmmov}

# with R2 and equation
plt.correlation_scatter_bcov_pmmov <-  {plot_scatter(.data = scatter_data_N_reco,
             x_var = `Copies/L WW_SARS CoV-2 N1`, y_var = `Copies/L WW_pMMoV_Vgp1`,
             colour_var = `Concentration method`,  shape_var = WWTP,
             already_pivoted_data = 'yes',
             title_text = 'SARS-CoV2 N1 vs surrogate recovery fraction across methods') + 
    scale_shape_manual(values = c(15,16,17,7,8,10,3)) } %>% 
  format_classic() %>% 
  print()

# save_plot('N1 vs pMMoV cor_all', sv.category = 'Correlation')

```


<!-- #### Interactive plot -->

<!-- Correlation across all data -->
<!-- ```{r interactcor}  -->
<!-- ggplotly(plt.correlation_scatter_N1_recovery, dynamicTicks = T) -->

<!-- ``` -->

<!-- Correlation across methods -->
<!-- ```{r interactcor2}  -->
<!-- ggplotly(plt.method.correlation_scatter_N1_recovery, dynamicTicks = T) -->

<!-- ``` -->

<!-- Correlation across wwtp -->
<!-- ```{r interactcor3}  -->
<!-- ggplotly(plt.bywwtp_N1_recovery, dynamicTicks = T) -->

<!-- ``` -->

<!-- Correlation across all categories (removing direct extraction) -->
<!-- ```{r interactcor4} -->
<!-- ggplotly(plt.nodirect_corr_all, dynamicTicks = T) -->

<!-- ``` -->

<!-- Correlation across all categories (removing direct extraction and elution) -->
<!-- ```{r interactcor5} -->
<!-- ggplotly(plt.nodirectelution_corr_all, dynamicTicks = T) -->

<!-- ``` -->
