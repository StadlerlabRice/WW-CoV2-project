---
title: "706 Rice"
author: "Prashant Kalvapalle"
date: "12 July 2020"
output: 
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.width = 12, fig.height = 4)

# Loading libraries, functions and user inputs
source('./general_functions.R') # Source the general_functions file
source('./inputs_for_analysis.R') # Source the file with user inputs


# Spike in and concentration details
# HA_concentration_factor <- 1000 # concentration factor of wastewater -> RNA
elution_volume <- 50 # ul - RNA extraction final volume

# copies/ul viral suspension spiked in (Spike ID: S16)
all_spike_virus_conc <- tibble(Target = c('BCoV_M', 'BRSV_N'), spike_virus_conc = c(10609, NA))
spike_virus_volume <- 50 # ul of viral suspension spiked in x ml WW; (x ~ 350 - 450 and varies for each sample)

# sheets to read from qPCR data dump excel file
read_these_sheets <- c('dd.WW6_706-1_N1/N2', 'dd.WW7_706-2_N1/N2', 'WW28_706-1_BCoV', 'WW29_706-2_BCoV_Std13')
title_name <- '706 Rice'

# Biobot ID sheet
bb_sheets <- c('Week 13 (7/6)')

# Extra categories for plotting separately (separate by | like this 'Vaccine|Troubleshooting')
extra_categories = 'Std|Control' # for excluding this category from a plot, make the switch (exclude_sample = TRUE)

# To rename samples with descriptive category/names (usually for extra TR experiments)
# - For other samples: Make it empty an string (like this '' ) to avoid messing up names inadvertantly
# translate_id_manual <- c('WW/Field', 'Water/Field', 'WW/Lab',  'Water/Lab', 'Solids/Present', 'Solids/Removed', 'Bead-beating/Dilter', 'Bead-beating/No filter') %>% setNames(str_c('^', c('A','B','C','D','E','F','G','H')))
translate_id_manual <- c('none' = 'none')

same_bottle_for_triplicates <- 'yes' # 'yes' if 1 bottle yields 3 x 50 ml. 'no' if 3 independant bottles yield 50 ml each
```

## Goal of the analysis

Quantifying CoV2-N1,N2 (multiplexed) and BCoV spike in in 6/8 wastewater samples

## Plots with raw names

### Individual biological replicates

```{r scripts, fig.width = 12}

# Acquire all the pieces of the data : read saved raw qPCR results from a google sheet
list_rawqpcr <- map(read_these_sheets, ~ read_sheet('https://docs.google.com/spreadsheets/d/1ouk-kCJHERRhOMNP07lXfiC3aGB4wtWXpnYf5-b2CI4/edit#gid=0', sheet = ., range = 'A:H')) 

rawqpcr <- bind_rows(list_rawqpcr)
results_abs <- rawqpcr %>% filter(!str_detect(`Sample Name`, '/')) # remove Baylor samples (5/26 and 6/2) - processed separately


# plot individual biological replicates
map2(list_rawqpcr, read_these_sheets, ~(plot_biological_replicates(.x, title_text = .y)))

```

### Summary plot

```{r summary}

summary_results_abs <- results_abs %>% group_by(Target, `Sample Name`, assay_variable) %>% summarise_at('Copy #', funs(mean(.,na.rm = T), sd(., na.rm = T)))

# plot copy # vs sample (assay_variable)
plot_mean_sd_jitter(summary_data = summary_results_abs, raw_data = results_abs, long_format = F) %>% format_logscale_y() %>% print()
```

## Comprehensive plots (WWTP labels)

### Summary plot

```{r biobot_to_WWTP}

# Bring WWTP names from google sheet: "Biobot Sample IDs"
biobot_lookup <- map_df(bb_sheets , 
                        ~ read_sheet('https://docs.google.com/spreadsheets/d/1ghb_GjTS4yMFbzb65NskAlm-2Gb5M4SNYi4FHE4YVyI/edit#gid=233791008', sheet = .x) %>% 
  rename('Biobot ID' = matches('Biobot|Comments', ignore.case = T), 'WWTP' = contains('SYMBOL', ignore.case = T), 'FACILITY NAME' = matches('FACILITY NAME', ignore.case = T)) %>% 
  mutate('Biobot ID' = str_remove(`Biobot ID`,'\\.'), WWTP = as.character(WWTP)) %>% 
  select(`Biobot ID`, `FACILITY NAME`, WWTP)
)

# polishing qPCR data - Make Biobot ID column clean
qpcr_polished <- results_abs %>% unite('Biobot ID', c(`Sample Name`, assay_variable), sep = '', remove = F) %>%
  select(-`Well Position`) %>% 
  mutate_at('assay_variable', as.character) %>% 
  mutate_at('biological_replicates', ~str_replace_na(., ''))

# Join WWTP names to qPCR dataset
bb_qpcr <- left_join(qpcr_polished, biobot_lookup, by = 'Biobot ID') %>% mutate_at(c('WWTP', 'FACILITY NAME'), ~if_else(str_detect(., '^X')|is.na(.), assay_variable, .)) %>% 
  mutate_at('Tube ID', ~str_remove(., "\\.")) %>%  unite('Label_tube', c('Sample Name', 'Tube ID'), sep = "", remove = F) # make a unique column for matching volumes

summary_bb_qpcr <- bb_qpcr %>% group_by(Target, `Sample Name`, `FACILITY NAME`, WWTP) %>% summarise_at('Copy #', funs(mean(.,na.rm = T), sd(., na.rm = T)))

# order samples by ascending order of BCoV
WWTP_order_1 <- summary_bb_qpcr %>% 
  filter( str_detect(Target,'BCoV')) %>% arrange(`mean`) %>% 
  pull(WWTP) %>% 
  unique() # accounts for duplicate labels - for controls and standards

summary_bb_qpcr$WWTP %<>%  fct_relevel(levels = WWTP_order_1) # order samples by ascending order of BCoV 


plot_mean_sd_jitter(summary_bb_qpcr, bb_qpcr, sample_var = extra_categories, exclude_sample = T, x_var = WWTP) %>% format_logscale_y() %>% print()

```

### Recovery

open circles : Viral copies spiked in
```{r Recovery_calculations}

# Get volumes data from google sheet : "Sample registry"
volumes_data <- read_sheet('https://docs.google.com/spreadsheets/d/1mJcCt1wMiOuBic6sRlBZJf8KSNu2y-B5PjzCUu7jPM8/edit#gid=521099478', sheet = 'Concentrated samples') %>% 
  rename('WW_vol' = `Total WW vol measured (ml)`, 'Label_tube' = `Label on tube`, vol_extracted = `WW volume extracted (ml)`) %>% 
  mutate('WW_vol' = coalesce(WW_vol, `Total WW volume calculated (ml)`) ) %>% 
  select(WW_vol, Label_tube, vol_extracted) %>% 
  distinct() %>% 
  mutate_at('Label_tube', ~str_remove_all(., " ")) %>% 
  
  # removing wrongly entered volumes for replicates, replacing with the max volume
  {if(same_bottle_for_triplicates == 'yes') { 
    mutate(., unique_labels = str_remove(Label_tube,'[1-3]$')) %>% 
    group_by(unique_labels) %>% 
    mutate_at('WW_vol', max, na.rm = T) %>% 
    ungroup() %>% 
    select(-unique_labels)
    }
  }
    
# join the results with the WWTP identifiers and names
vol_qpcr <- bb_qpcr %>% left_join(volumes_data, by = 'Label_tube') %>% 
  left_join(all_spike_virus_conc, by = 'Target') %>%  # spike in concentrations (BCoV and BRSV)
  
  # Calculations for spiked in and recovered copies of the virus
  mutate(`Actual spike-in` = spike_virus_conc * spike_virus_volume / (WW_vol * 1e-3), Recovered = `Copy #` * 1e3 * elution_volume/vol_extracted, `Recovery fraction` = 100 * Recovered/`Actual spike-in`) %>% 
  mutate_cond(str_detect(`Sample Name`, 'Vaccine'), `Actual spike-in` = spike_virus_conc * spike_virus_volume / (.050 * 1e-3), Recovered = `Copy #` * 1e6 * 50/20, `Recovery fraction` = 100 * Recovered/`Actual spike-in`) %>% 
  select(-spike_virus_conc)
 
```


```{r summarizing_plot}

# Adding a dummy CT column (if only ddPCR data is being loaded; which lacks the CT column) - for compatibility with qPCR code
if(vol_qpcr %>%  {!'CT' %in% colnames(.)}) vol_qpcr$CT = NA

# Picking out only spike-in quantification
spike_qpcr <- vol_qpcr %>% filter(str_detect(Target, 'BCoV|BRSV')) %>% 
  select(c(CT, Target, `Sample Name`, `Copy #`:`Recovery fraction` ))

if(!sum(translate_id_manual == 'none'))
{ spike_qpcr %<>% mutate_at(c('WWTP', 'FACILITY NAME'), ~str_replace_all(., translate_id_manual)) %>% 
  separate(WWTP, c('WWTP', 'tmp')) %>% 
  mutate_cond(str_detect(`Sample Name`, 'TR'), 'Sample Name' = WWTP, 'WWTP' = tmp) %>% 
  select(-tmp)
}

# Below code and plots executed only if spike quantification exists in the data
if(spike_qpcr %>% plyr::empty() %>% !.) {
  # Summarize mean and SD for biological replicates
  vol_qpcr_summary <- spike_qpcr %>% select(-WW_vol, -vol_extracted) %>% group_by(Target, `Sample Name`, `FACILITY NAME`, WWTP) %>% summarise_at(vars(2,3:5), funs(mean(.,na.rm = T), sd(.,na.rm = T))) 
  
  # order samples by ascending order of BCoV copies
  # WWTP_order <- vol_qpcr_summary %>% filter(str_detect(Target,'BCoV')) %>% arrange(`Copy #_mean`) %>% pull(WWTP) 
  vol_qpcr_summary$WWTP %<>%  fct_relevel(levels = WWTP_order_1) # order samples by BCoV ascending order
  
  # Convert data into long form
  long_vol_qpcr_summary <- vol_qpcr_summary %>% gather(key = 'Measurement', value = 'Reading', -Target, -`Sample Name`, -`FACILITY NAME`, -WWTP) %>% separate(Measurement, into = c('Measurement','val'),"_") %>% spread(val,Reading) # Seperate mean and variance and group by variable of measurement
  
  long_vol_qpcr_raw <- spike_qpcr %>% gather(key = 'Measurement', value = 'val', -Target, -`Sample Name`, -WWTP, -`FACILITY NAME`) # Seperate mean and variance and group by variable of measurement
  
  # plot recovery and spiked in
  reco_plot <- plot_mean_sd_jitter(long_vol_qpcr_summary, long_vol_qpcr_raw, long_format = T, measure_var = 'Recovered', sample_var = str_c(extra_categories), exclude_sample = T, x_var = WWTP, ylabel = 'Genome copies/l Wastewater') 
  
  reco_plot %>%  format_logscale_y() %>% print()

}

```

### % recovery

```{r percentreco}

# Below code and plots executed only if spike quantification exists in the data
spike_qpcr %>% plyr::empty() %>% if(!.)
{
  plot_mean_sd_jitter(long_vol_qpcr_summary, long_vol_qpcr_raw, sample_var = str_c(extra_categories, '|Vaccine'), exclude_sample = T, long_format = T,  measure_var = 'Recovery fraction', x_var = WWTP, ylabel = 'Fraction of spike-in recovered') %>% print()
  
}
  
```

### Controls and additional samples

```{r controls_recos, fig.width= 6}

  
extra_samples_to_plot <- str_c(extra_categories, '|Vaccine|NTC') %>% str_remove('\\|Std|Std\\|')

# N1/N2 and BCoV plots
plot_mean_sd_jitter(summary_bb_qpcr, bb_qpcr, sample_var = extra_samples_to_plot, exclude_sample = F, x_var = WWTP) %>% format_logscale_y() %>% print()

# Normalized recovery: N1/N2 and BCoV plots
reco_ex <- vol_qpcr %>% filter(str_detect(`Sample Name`,extra_samples_to_plot)) %>% ggplot(aes(x = WWTP, y = Recovered, colour = Target)) + geom_point() + facet_grid(~ `Sample Name`,  scales = 'free_x', space = 'free_x') + ylab('Genome copies/l Wastewater') + xlab('Sample Name')

reco_ex %>% format_logscale_y() %>% format_classic() %>% print()


if(spike_qpcr %>% plyr::empty() %>% !.) {
    
  # recovered vs spiked in plot for extra samples
   plot_mean_sd_jitter(long_vol_qpcr_summary, long_vol_qpcr_raw, long_format = T, measure_var = 'Recovered', sample_var = extra_samples_to_plot, exclude_sample = F, x_var = WWTP, ylabel = 'Genome copies/l Wastewater') %>%
     format_logscale_y() %>% print()
  
   # % plot for extra samples
   plot_mean_sd_jitter(long_vol_qpcr_summary, long_vol_qpcr_raw, sample_var = extra_samples_to_plot, exclude_sample = F, long_format = T,  measure_var = 'Recovery fraction', x_var = WWTP, ylabel = 'Fraction of spike-in recovered') %>% print()
   
}
  
```


## Scatter plots

### N1 vs N2 replicate

```{r n1n2}

long_targets_vol <- vol_qpcr %>% 
  select(c(Target, `Sample Name`, biological_replicates:WWTP , -CT)) %>% 
  filter(!str_detect(`Sample Name`, str_c(extra_categories, '|NTC'))) %>% 
  pivot_wider(names_from = 'Target', values_from = 'Copy #')

# NOTE: This function is very useful - errors here indicate that there are overlapping labels in the data: Check the sample naming sheet first thing
plot_scatter(long_targets_vol) %>% print()
```

### N1 vs N2 avg

```{r n1n2avg}

long_targets_vol_summary <- vol_qpcr %>% 
  select(-WW_vol) %>% 
  group_by(Target, `Sample Name`, `FACILITY NAME`, WWTP) %>% 
  summarise_at('Copy #', funs(mean(.,na.rm = T))) %>% 
  filter(!str_detect(`Sample Name`, str_c(extra_categories, '|NTC|Vaccine'))) %>% 
  pivot_wider(names_from = 'Target', values_from = 'Copy #')

plot_scatter(long_targets_vol_summary) %>% print()
```

### BCoV vs N2 avg

```{r n2bcov}
long_targets_vol_summary %>% {'BCoV_M' %in% colnames(.)} 
{
 plot_scatter(long_targets_vol_summary, x_var = BCoV_M) %>% print()
}

```

## Streamlined plots

### N1 N2 data

```{r n1n2streamlined}

bb_Ndata <- list(summary_bb_qpcr, bb_qpcr) %>% 
  map(~ 
        filter(., str_detect(Target, '^N')) %>% 
        mutate_at('WWTP', ~as.character(.)) %>%
        arrange(`FACILITY NAME`) 
      ) %>%
  setNames(c('summary', 'raw'))

pltN <- plot_mean_sd_jitter(bb_Ndata$summary, bb_Ndata$raw, sample_var = str_c(extra_categories,'|NTC|Vaccine'), exclude_sample = T, x_var = as_factor(WWTP), facet_var = NULL) 

pltN %>% print()
pltN %>% format_logscale_y() %>% print()
```



### Recovery data

```{r percentRecoverystreamlined}

spike_qpcr %>% plyr::empty() %>% if(!.)
{
  recostr_plot <- plot_mean_sd_jitter(long_vol_qpcr_summary, long_vol_qpcr_raw, long_format = T, measure_var = 'Recovery fraction', sample_var = str_c(extra_categories,'|NTC|Vaccine'), exclude_sample = T, x_var = as_factor(WWTP), facet_var = NULL, ylabel = 'Percentage recovery')
  
  recostr_plot %>% print()
}

```

## Data output

```{r summarydatadisplay}
presentable_vol_qpcr <- vol_qpcr %>% 
  
  # renaming variables
  rename('Facility' = `FACILITY NAME`, 'Original Sample Volume' = WW_vol, Ct = CT, 'Target Name' = Target) %>%
  rename('Copies/ul RNA' = `Copy #`, 'Copies/l WW' = Recovered, 'Spiked-in Copies/l WW' = `Actual spike-in`) %>%
  
  # Adding new variables, modifying existing variables
  mutate(Date = 'Manual entry', Lab = 'R', 'Volume Filtered' = 50, Bottle = NA) %>% 
  mutate_at('Sample Name', ~as.character(.)) %>%
  mutate_at('Facility', ~if_else(. == assay_variable, str_c(`Sample Name`, '/', assay_variable), .)) %>%
  mutate(Tube_ID = if_else(biological_replicates == ''|is.na(biological_replicates), str_c(`Sample Name`, ' ', assay_variable), str_c(`Sample Name`, ' ', assay_variable, '', biological_replicates)) ) %>% 
  mutate(WWTP_ID = if_else(biological_replicates == ''|is.na(biological_replicates), str_c(`Sample Name`, '.', WWTP) , str_c(`Sample Name`, '.', WWTP, '-', biological_replicates))) %>% 
  mutate('Limit of detection (copies/ul RNA)' = if_else(str_detect(`Target Name`, 'N1|N2'), 0.3, 0.5 )) %>% 
  
  # Arrange rows by WWTP facility 
  arrange(Facility, biological_replicates) %>%
  # unite('Facility', c(Facility, biological_replicates), sep = "-", na.rm = T) %>%
  mutate_cond(str_detect(`Target Name`, '^N'), `Recovery fraction` = NA, `Spiked-in Copies/l WW` = NA) %>%
  
  # Selecting column order
  select(Facility, WWTP, Date, Lab, `Target Name`, `Original Sample Volume`, `Volume Filtered`, Ct, `Copies/ul RNA`, `Copies/l WW`, Bottle, `Spiked-in Copies/l WW`, `Recovery fraction`, WWTP_ID, Tube_ID) %>%
  mutate_at('Target Name', ~str_replace_all(., c('.*N1.*' = 'SARS CoV-2 N1', '.*N2.*' = 'SARS CoV-2 N2')))



# presentable data for discussion with Baylor
write_sheet(presentable_vol_qpcr,'https://docs.google.com/spreadsheets/d/1ltvW7xZf2aUPoBchD4NFGuV0gGWPkdsOW3a0Hxalm-Y/edit#gid=2113120147', sheet = title_name)  # save results to a google sheet


# presentable data for health department
present_N_data <- presentable_vol_qpcr %>% filter(!str_detect(Facility, "Vaccine|Controls|Water|NTC|Blank|Std"), str_detect(`Target Name`, "^SARS")) %>%  # select only N1,N2 - remove distracting data
select(-`Recovery fraction`, -`Spiked-in Copies/l WW`, -Tube_ID)

# Write data if not empty
if(present_N_data %>% is_empty() %>% !.){
  write_sheet(present_N_data,'https://docs.google.com/spreadsheets/d/1dBESjgWSFsOBodFFpYNhWIOAQ2a3wvoLkrn12V_rFck/edit#gid=0', sheet = title_name) # save results to a google sheet
}

# summary_results %<>% mutate_if(is.numeric, format, digits = 3, scientific = T)
# kable(summary_results, caption = 'Summary of estimated copy #s')
```

<!-- ### Individual replicates -->
<!-- ```{r datadisplay} -->
<!-- results_abs %<>% mutate_if(is.numeric, format, digits = 3, scientific = T) -->
<!-- kable(results_abs, caption = 'Raw data and estimated copy #s') -->
<!-- ``` -->
